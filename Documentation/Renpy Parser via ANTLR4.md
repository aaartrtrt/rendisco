# Renpy Parser via ANTLR4

This code covers notes for ANTLR4-based RenPy parsing.

## Context

As part of this project, a significant amount of the parsing has been relegated to ANTLR4. This was done in order to decrease the load of manually writing logic on string parsing but most importantly, to improve visibility of how the parser is reading the language.

Currently, generated code is placed under the `./RenDisco/RenpyParser` directory, so you shouldn't need to generate new code every time you check out.

## Decisions regarding grammar

The Grammar is not exhaustive, but there are some key parts to note especially if you've worked with ANTLR4 for DSLs in the past.

### ANTLR-Denter for Python Indentation

RenPy is a Python-like language. This has culminated into some protracted work into parsing Python-like languages via a version-bumped [antlr-denter](https://github.com/aaartrtrt/antlr-denter) for C#.
  
You will notice that there are added `@lexer::header` and `@lexer::member` specifications in the grammar.

```antlr4
tokens {
  INDENT,
  DEDENT,
  ...
}

@lexer::header {
  using AntlrDenter;
}

@lexer::members {
  private DenterHelper denter;

  public override IToken NextToken()
  {
    if (denter == null)
    {
      denter = DenterHelper.Builder()
        .Nl(NL)
        .Indent(RenpyParser.INDENT)
        .Dedent(RenpyParser.DEDENT)
        .PullToken(base.NextToken);
    }

    return denter.NextToken();
  }
}
```

These extensions firstly imports the `AntlrDenter` into the lexer, and injects the `DenterHelper` logic into the lexer to handle indentation.

## Regenerating the ANTLR Code

### Prerequisites

* .NET 8.0.
* Python 3.12.
    * `antlr4-tools==0.2.1` via Pip.

        ```sh
        $ pip install antlr4-tools==0.2.1
        ```
* Java 11.

    For this project, the Eclipse Temurin distribution has been used. You can install this via [SDKMan](https://sdkman.io/jdks#tem) or [directly via binaries](https://adoptium.net/temurin/releases/?version=11).

    ```sh
    $ curl -s "https://get.sdkman.io" | bash
    $ source "~/.sdkman/bin/sdkman-init.sh"
    $ sdk install java 11.0.25-tem
    ```

### Generating the ANTLR4 Autogenerated code in `./RenDisco/RenpyParser` from `Renpy.g4`

```sh
$ antlr4 ./RenDisco/Renpy.g4 -Dlanguage=CSharp -visitor -o ./RenDisco/Antlr4
```

### Automating this Process

There are currently some options like [Antlr4BuildTasks](https://github.com/kaby76/Antlr4BuildTasks) that rely on injecting itself during a build so that added attributes to a `*.csproj` would allow any number of `*.g4` definitions to be used to generate classes at build-time.

There might be some work here in the future, but a lot of the work is targetting Unity, which is conducive to a bit of anxiety on whether build-time libraries would function as expected.
